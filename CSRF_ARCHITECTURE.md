```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   CSRF PROTECTION ARCHITECTURE OVERVIEW                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            FRONTEND (React/Vite)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  App Component (App.tsx)                                                        â”‚
â”‚  â””â”€â”€ Initializes React Query & Providers                                        â”‚
â”‚      â”œâ”€â”€ AuthProvider â”€â”€â”                                                       â”‚
â”‚      â””â”€â”€ CartProvider   â”‚                                                       â”‚
â”‚                         â”‚                                                       â”‚
â”‚  Components on Mount:   â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ 1. initializeCSRFToken()                                              â”‚      â”‚
â”‚  â”‚    â””â”€â”€ Generates 32-byte random token                                â”‚      â”‚
â”‚  â”‚    â””â”€â”€ Stores in localStorage['X-CSRF-Token']                        â”‚      â”‚
â”‚  â”‚    â””â”€â”€ Returns token (64-char hex string)                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                  â”‚
â”‚  API Calls (all components):                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ User Action (POST/PUT/DELETE)                                         â”‚      â”‚
â”‚  â”‚ â””â”€â”€ Component uses: apiPost(), apiPut(), apiDelete()                 â”‚      â”‚
â”‚  â”‚                                                                        â”‚      â”‚
â”‚  â”‚ API Client (src/lib/api-client.ts):                                  â”‚      â”‚
â”‚  â”‚ â”œâ”€â”€ Check if SAFE_METHOD (GET/HEAD/OPTIONS)                          â”‚      â”‚
â”‚  â”‚ â”‚   â””â”€ Yes: Call fetch without CSRF token                            â”‚      â”‚
â”‚  â”‚ â”‚   â””â”€ No: Continue to next step                                     â”‚      â”‚
â”‚  â”‚ â”‚                                                                     â”‚      â”‚
â”‚  â”‚ â”œâ”€â”€ Retrieve token from localStorage                                 â”‚      â”‚
â”‚  â”‚ â”‚   â””â”€ Token: getCSRFToken() â†’ localStorage.getItem(...)             â”‚      â”‚
â”‚  â”‚ â”‚                                                                     â”‚      â”‚
â”‚  â”‚ â”œâ”€â”€ Add CSRF header to request:                                      â”‚      â”‚
â”‚  â”‚ â”‚   â”œâ”€â”€ Header: X-CSRF-Token: <token>                                â”‚      â”‚
â”‚  â”‚ â”‚   â”œâ”€â”€ Cookie: csrf-token=<token> (credentials: include)            â”‚      â”‚
â”‚  â”‚ â”‚   â””â”€â”€ Content-Type: application/json                               â”‚      â”‚
â”‚  â”‚ â”‚                                                                     â”‚      â”‚
â”‚  â”‚ â””â”€â”€ Make fetch request with credentials                              â”‚      â”‚
â”‚  â”‚     â””â”€â”€ credentials: 'include' (sends/receives cookies)              â”‚      â”‚
â”‚  â”‚                                                                        â”‚      â”‚
â”‚  â”‚ HTTP Request:                                                         â”‚      â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚      â”‚
â”‚  â”‚ â”‚ POST /api/orders                                             â”‚     â”‚      â”‚
â”‚  â”‚ â”‚                                                              â”‚     â”‚      â”‚
â”‚  â”‚ â”‚ Headers:                                                    â”‚     â”‚      â”‚
â”‚  â”‚ â”‚   Content-Type: application/json                           â”‚     â”‚      â”‚
â”‚  â”‚ â”‚   Authorization: Bearer <jwt-token>                        â”‚     â”‚      â”‚
â”‚  â”‚ â”‚   X-CSRF-Token: a1b2c3d4e5f6... (32 bytes â†’ 64 chars)     â”‚     â”‚      â”‚
â”‚  â”‚ â”‚                                                              â”‚     â”‚      â”‚
â”‚  â”‚ â”‚ Cookies:                                                    â”‚     â”‚      â”‚
â”‚  â”‚ â”‚   csrf-token=a1b2c3d4e5f6... (same value)                 â”‚     â”‚      â”‚
â”‚  â”‚ â”‚   sessionId=xxx... (if session-based)                      â”‚     â”‚      â”‚
â”‚  â”‚ â”‚                                                              â”‚     â”‚      â”‚
â”‚  â”‚ â”‚ Body:                                                       â”‚     â”‚      â”‚
â”‚  â”‚ â”‚ {                                                           â”‚     â”‚      â”‚
â”‚  â”‚ â”‚   "data": {                                                â”‚     â”‚      â”‚
â”‚  â”‚ â”‚     "customer_name": "John Doe",                          â”‚     â”‚      â”‚
â”‚  â”‚ â”‚     "customer_email": "john@example.com"                  â”‚     â”‚      â”‚
â”‚  â”‚ â”‚   }                                                        â”‚     â”‚      â”‚
â”‚  â”‚ â”‚ }                                                           â”‚     â”‚      â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                  â”‚
â”‚  Storage:                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ localStorage                                                          â”‚      â”‚
â”‚  â”‚ {                                                                    â”‚      â”‚
â”‚  â”‚   "X-CSRF-Token": "a1b2c3d4e5f6789...7f8g9h0i1j2k3l4m5n6o7p8q9r0" â”‚      â”‚
â”‚  â”‚ }                                                                    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â†“â†“â†“ HTTP â†“â†“â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BACKEND (Strapi/Node.js)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  Request Arrives at Server                                                      â”‚
â”‚  â””â”€> Express/Koa Router                                                         â”‚
â”‚                                                                                  â”‚
â”‚  Middleware Chain (config/middlewares.js):                                      â”‚
â”‚  â”œâ”€â”€ strapi::errors          â”                                                  â”‚
â”‚  â”œâ”€â”€ strapi::security        â”‚                                                  â”‚
â”‚  â”œâ”€â”€ strapi::cors            â”‚ Pre-processing                                   â”‚
â”‚  â”œâ”€â”€ strapi::logger          â”‚                                                  â”‚
â”‚  â”œâ”€â”€ strapi::body            â”˜  (parse request body)                           â”‚
â”‚  â”‚                                                                              â”‚
â”‚  â””â”€â–º api::middlewares.csrf â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CSRF VALIDATION POINT                  â”‚
â”‚      â”‚                                                                          â”‚
â”‚      â”‚  CSRF Middleware:                                                       â”‚
â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚      â”‚  â”‚ 1. Check HTTP Method                                     â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ GET/HEAD/OPTIONS?                                  â”‚         â”‚
â”‚      â”‚  â”‚       â””â”€ Yes: Skip validation, call next()               â”‚         â”‚
â”‚      â”‚  â”‚       â””â”€ No: Continue to step 2                          â”‚         â”‚
â”‚      â”‚  â”‚                                                            â”‚         â”‚
â”‚      â”‚  â”‚ 2. Extract CSRF Token from Headers                       â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ token = headers['x-csrf-token']                    â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ Missing? â†’ Return 403 "Token missing in header"   â”‚         â”‚
â”‚      â”‚  â”‚                                                            â”‚         â”‚
â”‚      â”‚  â”‚ 3. Extract CSRF Token from Cookies                       â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ token = cookies.get('csrf-token')                  â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ Missing? â†’ Return 403 "Token missing in cookie"   â”‚         â”‚
â”‚      â”‚  â”‚                                                            â”‚         â”‚
â”‚      â”‚  â”‚ 4. Validate Token Format                                 â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ Pattern: ^[a-f0-9]{64}$ (64 hex characters)        â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ Invalid? â†’ Return 403 "Token invalid format"      â”‚         â”‚
â”‚      â”‚  â”‚                                                            â”‚         â”‚
â”‚      â”‚  â”‚ 5. Compare Tokens                                        â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ header_token === cookie_token?                     â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ No: Log failure & return 403 "Token mismatch"     â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ Yes: Continue to next middleware                   â”‚         â”‚
â”‚      â”‚  â”‚                                                            â”‚         â”‚
â”‚      â”‚  â”‚ 6. Log Validation (optional)                             â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ Success: Log IP, method, endpoint                  â”‚         â”‚
â”‚      â”‚  â”‚    â””â”€ Failure: Log IP, timestamp, token (hash)           â”‚         â”‚
â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚      â”‚                                                                          â”‚
â”‚      â””â”€â–º Continue to Route Handler                                             â”‚
â”‚          â”‚                                                                      â”‚
â”‚          â””â”€â–º Controller (api/orders/controllers/orders.js)                     â”‚
â”‚              â”‚                                                                  â”‚
â”‚              â””â”€â–º Validate Request Data                                         â”‚
â”‚                  â”œâ”€â”€ Check required fields                                     â”‚
â”‚                  â”œâ”€â”€ Validate email format                                     â”‚
â”‚                  â”œâ”€â”€ Validate phone number                                     â”‚
â”‚                  â””â”€â”€ Check user permissions                                    â”‚
â”‚                      â”‚                                                         â”‚
â”‚                      â”œâ”€ Validation failed? â†’ Return 400 Bad Request           â”‚
â”‚                      â””â”€ Validation passed? â†’ Continue                         â”‚
â”‚                          â”‚                                                    â”‚
â”‚                          â””â”€â–º Database Operations                             â”‚
â”‚                              â”œâ”€â”€ Create order record                         â”‚
â”‚                              â”œâ”€â”€ Link order items                            â”‚
â”‚                              â”œâ”€â”€ Save to database                            â”‚
â”‚                              â””â”€â”€ Return 200 Success + Data                   â”‚
â”‚                                                                               â”‚
â”‚  Response Sent Back to Frontend:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚ HTTP/1.1 200 OK                        â”‚                                   â”‚
â”‚  â”‚                                         â”‚                                   â”‚
â”‚  â”‚ Content-Type: application/json         â”‚                                   â”‚
â”‚  â”‚ Set-Cookie: sessionId=xxx...;          â”‚                                   â”‚
â”‚  â”‚             Secure; HttpOnly;          â”‚                                   â”‚
â”‚  â”‚             SameSite=Strict             â”‚                                   â”‚
â”‚  â”‚                                         â”‚                                   â”‚
â”‚  â”‚ {                                       â”‚                                   â”‚
â”‚  â”‚   "data": {                            â”‚                                   â”‚
â”‚  â”‚     "id": "order_123",                â”‚                                   â”‚
â”‚  â”‚     "customer_name": "John Doe",      â”‚                                   â”‚
â”‚  â”‚     "status": "pending"                â”‚                                   â”‚
â”‚  â”‚   }                                    â”‚                                   â”‚
â”‚  â”‚ }                                       â”‚                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â†“â†“â†“ Response â†“â†“â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FRONTEND (React Component)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  Response Handling:                                                             â”‚
â”‚  â”œâ”€â”€ Parse response JSON                                                       â”‚
â”‚  â”œâ”€â”€ Update component state                                                    â”‚
â”‚  â”œâ”€â”€ Show success message to user                                              â”‚
â”‚  â”œâ”€â”€ Navigate to next page (if needed)                                         â”‚
â”‚  â””â”€â”€ Refresh CSRF token (optional):                                            â”‚
â”‚      â””â”€â”€ useCSRF().refresh() â†’ Generate new token                              â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          TOKEN LIFECYCLE DIAGRAM                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  App Initialization  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Call initializeCSRFToken()       â”‚
â”‚ â”œâ”€ Generate random 32 bytes      â”‚
â”‚ â”œâ”€ Convert to 64-char hex        â”‚
â”‚ â””â”€ Store in localStorage         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token in localStorage            â”‚
â”‚ X-CSRF-Token: abc123...def       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
      [Every API Call]
           â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                 â”‚                 â”‚
           â–¼                 â–¼                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ GET Request  â”‚  â”‚ POST/PUT/DEL â”‚  â”‚ Logout       â”‚
    â”‚ â†’ Skip CSRF  â”‚  â”‚ â†’ Add Token  â”‚  â”‚ â†’ Clear Tokenâ”‚
    â”‚ â†’ Call fetch â”‚  â”‚ â†’ Call fetch â”‚  â”‚ â†’ Remove Key â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Token in HTTP Header â”‚
                    â”‚ X-CSRF-Token: abc... â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Token in Cookie      â”‚
                    â”‚ csrf-token=abc...    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Backend Validation   â”‚
                    â”‚ (see middleware)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚
                    â–¼                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ âœ“ Valid      â”‚      â”‚ âœ— Invalid    â”‚
            â”‚ Continue     â”‚      â”‚ 403 Forbiddenâ”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         FILE DEPENDENCY DIAGRAM                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    App.tsx (entry point)
         â”‚
         â”œâ”€â–º AuthProvider
         â”‚   â””â”€ src/contexts/AuthContext.tsx
         â”‚       â””â”€ Uses: apiPost, apiPut, apiDelete from api-client.ts
         â”‚           â””â”€ src/lib/api-client.ts
         â”‚               â”œâ”€ Uses: csrf.ts functions
         â”‚               â”‚   â””â”€ src/lib/csrf.ts
         â”‚               â””â”€ Uses: initializeCSRFToken()
         â”‚
         â”œâ”€â–º CartProvider
         â”‚   â””â”€ src/contexts/CartContext.tsx
         â”‚       â””â”€ No CSRF usage (read-only)
         â”‚
         â””â”€â–º Pages (all routes)
             â”œâ”€ Index.tsx
             â”œâ”€ Products.tsx
             â”‚   â””â”€ GET requests only
             â”‚
             â”œâ”€ Checkout.tsx
             â”‚   â””â”€ Uses: apiPost from api-client.ts
             â”‚       â””â”€ Creates orders with CSRF protection
             â”‚
             â”œâ”€ SignUp.tsx
             â”‚   â””â”€ Uses: apiPost from AuthContext
             â”‚
             â”œâ”€ SignIn.tsx
             â”‚   â””â”€ Uses: apiPost from AuthContext
             â”‚
             â””â”€ UserSettings.tsx
                 â””â”€ Uses: apiPut from api-client.ts
                     â””â”€ Updates profile with CSRF


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         ERROR FLOW DIAGRAM                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

POST /api/orders with Invalid/Missing CSRF Token
â”‚
â”œâ”€ Missing in Header?
â”‚  â””â”€ Return 403: "CSRF Token missing in header"
â”‚
â”œâ”€ Missing in Cookie?
â”‚  â””â”€ Return 403: "CSRF Token missing in cookie"
â”‚
â”œâ”€ Invalid Format?
â”‚  â””â”€ Return 403: "CSRF Token invalid format"
â”‚
â”œâ”€ Token Mismatch?
â”‚  â”œâ”€ Log: IP, timestamp, method, endpoint
â”‚  â””â”€ Return 403: "CSRF Token validation failed"
â”‚
â””â”€ Valid Token?
   â””â”€ Proceed with request processing
      â”œâ”€ Validate data
      â”œâ”€ Check permissions
      â””â”€ Execute action


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         SECURITY LAYER SUMMARY                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Token Generation                                           â”‚
â”‚ â””â”€ Web Crypto API (cryptographically secure)                       â”‚
â”‚    â””â”€ 32 bytes (256 bits) random data                              â”‚
â”‚    â””â”€ Converted to 64-character hex string                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: Token Storage                                             â”‚
â”‚ â””â”€ Browser localStorage (protected by SOP)                         â”‚
â”‚    â””â”€ Cannot be accessed by other domains                          â”‚
â”‚    â””â”€ Not sent with XHR by default (must add header)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: Token Transmission                                        â”‚
â”‚ â”œâ”€ Header: X-CSRF-Token (not query param)                         â”‚
â”‚ â”œâ”€ Cookie: csrf-token (HttpOnly, Secure, SameSite)                â”‚
â”‚ â””â”€ Both together provide Double Submit Cookie protection           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: Backend Validation                                        â”‚
â”‚ â”œâ”€ Check format (must be valid hex)                                â”‚
â”‚ â”œâ”€ Compare header vs cookie (must match exactly)                   â”‚
â”‚ â””â”€ Reject if any mismatch (403 Forbidden)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 5: Transport Security                                        â”‚
â”‚ â”œâ”€ HTTPS only (Secure flag)                                        â”‚
â”‚ â”œâ”€ credentials: include (allow cross-site cookies)                 â”‚
â”‚ â”œâ”€ SameSite=Strict (only same-site requests)                       â”‚
â”‚ â””â”€ HttpOnly cookies (no JavaScript access)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        SUMMARY OF CSRF PROTECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Frontend: Fully Implemented
   â€¢ Token generation with Web Crypto API
   â€¢ Automatic token injection in requests
   â€¢ Token storage in localStorage
   â€¢ React hook for token management
   â€¢ Example implementations provided

ğŸ”§ Backend: Template Provided
   â€¢ CSRF middleware ready to use
   â€¢ Configuration examples included
   â€¢ Integration with Strapi documented
   â€¢ Error handling examples provided

ğŸ›¡ï¸  Security: Double Submit Cookie Pattern
   â€¢ Token in header (X-CSRF-Token)
   â€¢ Token in cookie (csrf-token)
   â€¢ Backend compares both
   â€¢ Cross-site requests cannot forge valid tokens

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```
